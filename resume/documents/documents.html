<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Documents (IndexedDB)</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f9fafb;
            padding: 2rem;
            color: #111827;
        }

        h1 {
            margin-bottom: .25rem;
        }

        .sub {
            color: #6b7280;
            margin-top: 0;
        }

        /* Storage summary */
        .storage-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin: 1rem 0 1.5rem;
            display: grid;
            gap: .5rem;
        }

        .storage-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .kpi {
            display: flex;
            flex-direction: column;
            gap: .25rem;
        }

        .kpi .label {
            font-size: .85rem;
            color: #6b7280;
        }

        .kpi .value {
            font-weight: 600;
        }

        .bar-wrap {
            grid-column: 1 / -1;
        }

        .bar-bg {
            width: 100%;
            height: 12px;
            background: #eef2ff;
            border-radius: 9999px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            width: 0%;
            background: #4f46e5;
            transition: width .6s ease;
        }

        .footnote {
            font-size: .85rem;
            color: #6b7280;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            margin-bottom: 1rem;
        }

        .btn {
            padding: .55rem .9rem;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-primary {
            background: #06b6d4;
            color: #fff;
        }

        .btn-ghost {
            background: #fff;
            color: #111827;
            border-color: #e5e7eb;
        }

        #searchInput {
            padding: .55rem .7rem;
            width: 260px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        .doc-types {
            display: flex;
            gap: 1rem;
            margin: 1rem 0 1rem;
        }

        .doc-types div {
            background: #fff;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            flex: 1;
            border-radius: 8px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            font-size: .95rem;
        }

        th {
            background: #f9fafb;
            color: #374151;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status {
            background: #d1fae5;
            color: #065f46;
            padding: .2rem .55rem;
            border-radius: 20px;
            font-size: .8rem;
            display: inline-block;
            margin-top: .35rem;
        }

        .action-btns a,
        .action-btns button {
            margin-right: .4rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
        }

        .delete-btn {
            color: #dc2626;
        }

        .rename-btn {
            color: #4b5563;
        }

        tfoot td {
            background: #fafafa;
            font-weight: 600;
        }

        @media (max-width: 720px) {
            .storage-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <div id="header-placeholder"></div>

    <h1>My Documents</h1>
    <p class="sub">Manage and tailor all of your job search documents here (stored locally via IndexedDB).</p>

    <!-- Storage Summary -->
    <section class="storage-card">
        <div class="storage-grid">
            <div class="kpi">
                <span class="label">Quota (origin)</span>
                <span class="value" id="quotaVal">—</span>
            </div>
            <div class="kpi">
                <span class="label">Used (origin)</span>
                <span class="value" id="usedVal">—</span>
            </div>
            <div class="kpi">
                <span class="label">Remaining (origin)</span>
                <span class="value" id="leftVal">—</span>
            </div>
            <div class="kpi">
                <span class="label">Resumes Total</span>
                <span class="value" id="resumesTotalVal">—</span>
            </div>
            <div class="bar-wrap">
                <div class="bar-bg">
                    <div class="bar-fill" id="usageBar"></div>
                </div>
            </div>
        </div>
        <div class="footnote">* Estimates include all storage for this origin (IndexedDB, Cache, localStorage, etc.).
            Per-file sizes here are exact (Blob sizes).</div>
    </section>

    <div class="toolbar">
        <input type="text" id="searchInput" placeholder="Search by name or date...">
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Upload a resume</button>
        <button class="btn btn-ghost" onclick="exportMetadata()">Export Metadata JSON</button>
        <button class="btn btn-ghost" onclick="document.getElementById('importInput').click()">Import JSON (migrates
            data URLs)</button>
    </div>

    <input type="file" id="fileInput" accept=".pdf,.doc,.docx" style="display:none;">
    <input type="file" id="importInput" accept="application/json" style="display:none;">

    <div class="doc-types">

        <a href="/resume" style="text-decoration: none;">
            <div style="
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background-color: #ffffff;
    max-width: 480px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
  ">
                <!-- Icon container -->
                <div style="
      background-color: #e0f7ff;
      border-radius: 50%;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    ">
                    <img src="data:image/png;base64,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"
                        alt="Resume Icon" style="height: 100px; width: 150px;">
                </div>

                <!-- Text -->
                <div>
                    <strong style="font-size: 1rem; color: #111827;">Resume</strong><br>
                    <small style="color: #6b7280;">Craft your perfect resume and tailor it to a job description</small>
                </div>
            </div>
        </a>

        <!-- <a href="/resume"><div><strong >Resume</strong><br><small>Tailor it to a job description</small></div></a> -->
        <!-- <div><strong>Cover Letter</strong><br><small>Customize with AI</small></div> -->
        <!-- <div><strong>Question Response</strong><br><small>Generate responses</small></div> -->
    </div>

    <table>
        <thead>
            <tr>
                <th>Resume Name</th>
                <th>Size</th>
                <th>Created</th>
                <th>Last Edited</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="resumeTableBody"></tbody>
        <tfoot>
            <tr>
                <td><em>Total</em></td>
                <td id="tableTotalSize">—</td>
                <td colspan="3"></td>
            </tr>
        </tfoot>
    </table>

    <script>
        fetch("/reusables/header.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("header-placeholder").innerHTML = html;
            });

        /* =========================
           IndexedDB setup
        ========================= */
        const DB_NAME = 'vereloop';
        const STORE = 'resumes';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    const _db = e.target.result;
                    if (!_db.objectStoreNames.contains(STORE)) {
                        const os = _db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                        os.createIndex('name', 'name', { unique: false });
                        os.createIndex('created', 'created', { unique: false });
                    }
                };
                req.onsuccess = () => { db = req.result; resolve(db); };
                req.onerror = () => reject(req.error);
            });
        }

        function txStore(mode = 'readonly') {
            const tx = db.transaction(STORE, mode);
            return [tx, tx.objectStore(STORE)];
        }

        function getAllResumes() {
            return new Promise((resolve, reject) => {
                const [tx, store] = txStore('readonly');
                const r = store.getAll();
                r.onsuccess = () => resolve(r.result || []);
                r.onerror = () => reject(r.error);
            });
        }

        function addResumeRecord({ name, mime, blob }) {
            return new Promise((resolve, reject) => {
                const now = Date.now();
                const [tx, store] = txStore('readwrite');
                const req = store.add({ name, mime, created: now, updated: now, data: blob });
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function updateResumeName(id, newName) {
            return new Promise(async (resolve, reject) => {
                const [tx, store] = txStore('readwrite');
                const getReq = store.get(id);
                getReq.onsuccess = () => {
                    const rec = getReq.result;
                    if (!rec) return reject(new Error('Not found'));
                    rec.name = newName;
                    rec.updated = Date.now();
                    const putReq = store.put(rec);
                    putReq.onsuccess = () => resolve(true);
                    putReq.onerror = () => reject(putReq.error);
                };
                getReq.onerror = () => reject(getReq.error);
            });
        }

        function deleteResumeById(id) {
            return new Promise((resolve, reject) => {
                const [tx, store] = txStore('readwrite');
                const req = store.delete(id);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error);
            });
        }

        function getResumeById(id) {
            return new Promise((resolve, reject) => {
                const [tx, store] = txStore('readonly');
                const req = store.get(id);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => reject(req.error);
            });
        }

        /* =========================
           UI helpers
        ========================= */
        const fileInput = document.getElementById('fileInput');
        const importInput = document.getElementById('importInput');
        const tableBody = document.getElementById('resumeTableBody');
        const searchInput = document.getElementById('searchInput');
        const usageBar = document.getElementById('usageBar');
        const quotaVal = document.getElementById('quotaVal');
        const usedVal = document.getElementById('usedVal');
        const leftVal = document.getElementById('leftVal');
        const resumesTotalVal = document.getElementById('resumesTotalVal');
        const tableTotalSizeEl = document.getElementById('tableTotalSize');

        function formatBytes(n) {
            if (n == null) return '—';
            const u = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (n >= 1024 && i < u.length - 1) { n /= 1024; i++; }
            const fixed = (n < 10 && i > 0) ? n.toFixed(1) : Math.round(n);
            return `${fixed} ${u[i]}`;
        }
        function formatDate(d) { return new Date(d).toLocaleString(); }

        async function refreshStorageEstimate() {
            try {
                const { usage = 0, quota = 0 } = await (navigator.storage?.estimate?.() ?? {});
                const remaining = Math.max(quota - usage, 0);
                quotaVal.textContent = formatBytes(quota);
                usedVal.textContent = formatBytes(usage);
                leftVal.textContent = formatBytes(remaining);
                const percent = quota ? Math.min(100, Math.round((usage / quota) * 100)) : 0;
                usageBar.style.width = percent + '%';
            } catch {
                quotaVal.textContent = usedVal.textContent = leftVal.textContent = '—';
                usageBar.style.width = '0%';
            }
        }

        async function updateTable(filter = '') {
            const items = await getAllResumes();
            tableBody.innerHTML = '';
            let tableTotal = 0;

            items.forEach((rec) => {
                const createdStr = formatDate(rec.created);
                const match = !filter ||
                    rec.name.toLowerCase().includes(filter.toLowerCase()) ||
                    createdStr.includes(filter);
                if (!match) return;

                const size = rec.data?.size ?? 0;
                tableTotal += size;

                const tr = document.createElement('tr');
                tr.innerHTML = `
      <td>
        <span>${rec.name}</span>
        <div class="status">Uploaded</div>
      </td>
      <td>${formatBytes(size)}</td>
      <td>${createdStr}</td>
      <td>${formatDate(rec.updated)}</td>
      <td class="action-btns">
        <button title="View" onclick="viewResume(${rec.id})">👁️</button>
        <button title="Download" onclick="downloadResume(${rec.id}, '${cssEscapeAttr(rec.name)}')">⬇️</button>
        <button class="rename-btn" title="Rename" onclick="promptRename(${rec.id}, '${cssEscapeAttr(rec.name)}')">✏️</button>
        <button class="delete-btn" title="Delete" onclick="confirmDelete(${rec.id})">🗑️</button>
      </td>
    `;
                tableBody.appendChild(tr);
            });

            tableTotalSizeEl.textContent = formatBytes(tableTotal);
            resumesTotalVal.textContent = formatBytes(tableTotal);
            refreshStorageEstimate();
        }

        // Escape quotes for inline attribute usage
        function cssEscapeAttr(s = '') {
            return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        /* =========================
           Actions
        ========================= */
        async function viewResume(id) {
            const rec = await getResumeById(id);
            if (!rec || !rec.data) return alert('Not found');
            const url = URL.createObjectURL(rec.data);
            window.open(url, '_blank');
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        }

        async function downloadResume(id, name = 'resume') {
            const rec = await getResumeById(id);
            if (!rec || !rec.data) return alert('Not found');
            const url = URL.createObjectURL(rec.data);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        }

        async function promptRename(id, currentName) {
            const newName = prompt('Enter a new name:', currentName);
            if (!newName || !newName.trim()) return;
            await updateResumeName(id, newName.trim());
            updateTable(searchInput.value);
        }

        async function confirmDelete(id) {
            if (!confirm('Are you sure you want to delete this resume?')) return;
            await deleteResumeById(id);
            updateTable(searchInput.value);
        }

        /* =========================
           Import / Export
        ========================= */
        async function exportMetadata() {
            const items = await getAllResumes();
            const meta = items.map(r => ({
                id: r.id, name: r.name, created: r.created, updated: r.updated, mime: r.mime, size: r.data?.size || 0
            }));
            const blob = new Blob([JSON.stringify(meta, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'vereloop_resumes_metadata.json';
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 10000);
        }

        // Import migration: accepts an array where items may include `url: data:...` (old localStorage backup)
        importInput.addEventListener('change', async () => {
            const file = importInput.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const arr = JSON.parse(text);
                if (!Array.isArray(arr)) throw new Error('Expected an array');

                // Add each record. If it contains a data URL, convert to Blob and store.
                for (const item of arr) {
                    let blob = null, mime = item.mime || 'application/octet-stream';
                    if (item.url && typeof item.url === 'string' && item.url.startsWith('data:')) {
                        // Convert data URL -> Blob
                        blob = await (await fetch(item.url)).blob();
                        mime = blob.type || mime;
                    }
                    if (blob) {
                        await addResumeRecord({ name: item.name || 'Imported Resume', mime, blob });
                    } else {
                        // If no data, skip or create a lightweight placeholder (optional)
                        // Skipping to avoid empty records.
                    }
                }
                alert('Import completed.');
                updateTable();
            } catch (e) {
                console.error(e);
                alert('Invalid JSON or import failed.');
            } finally {
                importInput.value = '';
            }
        });

        /* =========================
           Upload
        ========================= */
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) return;
            // Store the File directly as a Blob in IDB
            await addResumeRecord({ name: file.name, mime: file.type || 'application/octet-stream', blob: file });
            fileInput.value = '';
            updateTable(searchInput.value);
        });

        /* =========================
           Search
        ========================= */
        searchInput.addEventListener('input', () => updateTable(searchInput.value));

        /* =========================
           Init
        ========================= */
        (async function init() {
            await openDB();
            updateTable();
            // Optional: request persistent storage (reduces eviction risk)
            try { await navigator.storage?.persist?.(); } catch { }
        })();
    </script>
</body>

</html>